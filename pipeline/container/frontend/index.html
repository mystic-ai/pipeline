<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pipeline container â€” Mystic.ai</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link href="/static/styles.css" rel="stylesheet" />
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const fileRunIOTypes = ["pkl", "file"];

      // => boolean
      const isObject = (value) => {
        try {
          return (
            typeof value === "object" &&
            value !== null &&
            !(value instanceof Array)
          );
        } catch (e) {
          return false;
        }
      };

      // => boolean
      const isArray = (value) => {
        try {
          return Array.isArray(value);
        } catch (e) {
          return false;
        }
      };

      function isNullOrUndefined(value) {
        return value === null || value === undefined;
      }

      const isIONumber = (run_io_type) =>
        run_io_type === "integer" || run_io_type === "fp";

      const getIOControlType = (IOVariable) => {
        if (fileRunIOTypes.includes(IOVariable.run_io_type)) return "file";
        if (IOVariable.run_io_type === "boolean") return "checkbox";
        if (IOVariable.run_io_type) return "number";
        if (IOVariable.choices) return "select";
        return "text";
      };

      const getIOMin = (IOVariable) => {
        if (!isIONumber(IOVariable.run_io_type)) return;
        if (!isNullOrUndefined(IOVariable.gt)) {
          if (IOVariable.run_io_type === "fp") {
            if (IOVariable.multiple_of)
              return IOVariable.gt + IOVariable.multiple_of;
            else return IOVariable.gt + 0.1;
          } else {
            return IOVariable.gt + 1;
          }
        }
        if (!isNullOrUndefined(IOVariable.ge)) return IOVariable.ge;
      };

      const getIOMax = (IOVariable) => {
        if (!isIONumber(IOVariable.run_io_type)) return;
        if (!isNullOrUndefined(IOVariable.lt)) {
          if (IOVariable.run_io_type === "fp") {
            if (!isNullOrUndefined(IOVariable.multiple_of))
              return IOVariable.lt - IOVariable.multiple_of;
            else return IOVariable.lt - 0.1;
          } else {
            return IOVariable.lt - 1;
          }
        }
        if (!isNullOrUndefined(IOVariable.le)) return IOVariable.le;
      };

      const getIOStep = (IOVariable) => {
        if (!IOVariable.run_io_type) return;
        if (IOVariable.multiple_of) return IOVariable.multiple_of;
        if (IOVariable.run_io_type === "fp") {
          if (!isNullOrUndefined(IOVariable.decimal_places)) {
            return 1 / Math.pow(10, IOVariable.decimal_places);
          } else {
            return 0.01;
          }
        }

        return 1;
      };

      // Take in IOVariables and return a DynamicFieldData array
      // Format for HTML inputs
      const generateDynamicFieldsFromIOVariables = (IOVariables) => {
        return IOVariables.map((IOVariable, idx) => {
          return {
            id: `pipeline-play-input-${idx}`,
            label: IOVariable.title || `input-${idx}`,
            fieldName: IOVariable.title || `input-${idx}`,
            fieldDescription: IOVariable.description || "",
            inputType: getIOControlType(IOVariable),
            subType: IOVariable.run_io_type,
            options:
              IOVariable.choices && IOVariable.choices.length
                ? IOVariable.choices.map((choice) => ({
                    label: choice,
                    value: choice,
                  }))
                : [],
            max: getIOMax(IOVariable),
            min: getIOMin(IOVariable),
            step: getIOStep(IOVariable),
            dicts:
              IOVariable.dict_schema && IOVariable.dict_schema.length
                ? generateDynamicFieldsFromIOVariables(IOVariable.dict_schema)
                : undefined,
            defaultValue: !isNullOrUndefined(IOVariable.default)
              ? IOVariable.default
              : "",
            decimalPlaces: IOVariable.decimal_places,
            optional: IOVariable.optional,
          };
        });
      };

      const mockOutputIOVariables = [
        // {
        //   type: "string",
        //   value: "Hello, my name is Paul.",
        //   file: null,
        // },
        // {
        //   type: "array",
        //   value: [
        //     {
        //       timestamp: [0.0, 4.0],
        //       text: " Hello, my name is Paul.",
        //     },
        //   ],
        //   file: null,
        // },
        // {
        //   type: "dictionary",
        //   value: {
        //     some_array: [0.0, 4.0],
        //     some_nested_obj: {
        //       super_nested_object: {
        //         in_french: " Bonjour, mon nom c'est Paul.",
        //       },
        //     },
        //     another_value: " Hello, my name is Paul.",
        //   },
        //   file: null,
        // },
        // {
        //   type: "array",
        //   value: ["value1", "value2", "value3", "value4"],
        //   file: null,
        // },
        // {
        //   type: "array",
        //   value: [
        //     {
        //       type: "file",
        //       file: {
        //         name: "test2.png",
        //         path: "test.png",
        //         size: 123,
        //         url: "https://picsum.photos/200",
        //       },
        //     },
        //     {
        //       type: "file",
        //       file: {
        //         name: "test3.png",
        //         path: "test.png",
        //         size: 123,
        //         url: "https://picsum.photos/200",
        //       },
        //     },
        //   ],
        // },
        // {
        //   type: "file",
        //   file: {
        //     name: "test.png",
        //     path: "test.png",
        //     size: 123,
        //     url: "https://picsum.photos/200",
        //   },
        // },
        // {
        //   type: "array",
        //   value: [
        //     [
        //       0.011444582603871822, -0.05315866321325302, 0.021406110376119614,
        //       -0.026900190860033035, -0.015447557903826237, 0.043529216200113297,
        //       -0.03459615632891655, 0.00029987774905748665, -0.03525491803884506,
        //       0.03108358569443226, 0.01344769261777401, -0.0125086959451437,
        //       0.0056375423446297646, 0.046820446848869324, 0.029219090938568115,
        //       -0.03583495318889618, 0.043436795473098755, 0.031827159225940704,
        //     ],
        //   ],
        // },
        // {
        //   type: "file",
        //   value: null,
        //   file: {
        //     name: "0.wav",
        //     path: "run_files/7f/4d/7f4ddf85-6ea8-49ac-a77d-b53a06dface7/0.wav",
        //     url: "https://storage.mystic.ai/run_files/7f/4d/7f4ddf85-6ea8-49ac-a77d-b53a06dface7/0.wav",
        //     size: 256044,
        //   },
        // },
        // {
        //   type: "file",
        //   value: null,
        //   file: {
        //     name: "0.mp4",
        //     path: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm",
        //     url: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm",
        //     size: 256044,
        //   },
        // },
      ];
      const mockInputIOVariables = [
        {
          run_io_type: "string",
          title: "string_1",
          description: null,
          examples: null,
          gt: null,
          ge: null,
          lt: null,
          le: null,
          multiple_of: null,
          allow_inf_nan: null,
          max_digits: null,
          decimal_places: null,
          min_length: null,
          max_length: null,
          choices: null,
          dict_schema: null,
          default: "chat_completion",
        },
        // {
        //   run_io_type: "array",
        //   title: "array_dict",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: [
        //     {
        //       test: true,
        //       array_length: 1,
        //     },
        //   ],
        // },
        // {
        //   run_io_type: "array",
        //   title: "super_array",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: [
        //     0.011444582603871822, -0.05315866321325302, 0.021406110376119614,
        //     -0.026900190860033035, -0.015447557903826237, 0.043529216200113297,
        //     -0.03459615632891655, 0.00029987774905748665, -0.03525491803884506,
        //     0.03108358569443226, 0.01344769261777401, -0.0125086959451437,
        //     0.0056375423446297646, 0.046820446848869324, 0.029219090938568115,
        //     -0.03583495318889618, 0.043436795473098755, 0.031827159225940704,
        //   ],
        // },
        // {
        //   run_io_type: "string",
        //   title: "choices_1",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: ["choice1", "choice2", "choice3"],
        //   dict_schema: null,
        //   default: "choice3",
        // },
        // {
        //   run_io_type: "fp",
        //   title: "fp",
        //   description: "something more about this input",
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: 0.0001,
        // },
        // {
        //   run_io_type: "fp",
        //   title: "fp_min_max",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: 5,
        //   lt: null,
        //   le: 20,
        //   multiple_of: 5,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: 10,
        // },
        // {
        //   run_io_type: "fp",
        //   title: "fp_with_default",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: 1.234,
        // },
        // {
        //   run_io_type: "fp",
        //   title: "fp_with_default_multiple_of_0.1",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: 0.00004,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: 5,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: 1.234567,
        // },
        // {
        //   run_io_type: "fp",
        //   title: "fp_with_gt_le_step",
        //   description: null,
        //   examples: null,
        //   gt: 1,
        //   ge: null,
        //   lt: 2,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: 1.1,
        // },
        // {
        //   run_io_type: "boolean",
        //   title: "boolean",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: null,
        //   default: true,
        // },
        // {
        //   run_io_type: "dictionary",
        //   title: "dictionary_test",
        //   description: null,
        //   examples: null,
        //   gt: null,
        //   ge: null,
        //   lt: null,
        //   le: null,
        //   multiple_of: null,
        //   allow_inf_nan: null,
        //   max_digits: null,
        //   decimal_places: null,
        //   min_length: null,
        //   max_length: null,
        //   choices: null,
        //   dict_schema: [
        //     {
        //       run_io_type: "integer",
        //       title: "guidance_scale",
        //       description: null,
        //       examples: null,
        //       gt: null,
        //       ge: null,
        //       lt: null,
        //       le: null,
        //       multiple_of: null,
        //       allow_inf_nan: null,
        //       max_digits: null,
        //       decimal_places: null,
        //       min_length: null,
        //       max_length: null,
        //       choices: null,
        //       dict_schema: null,
        //       default: 7.5,
        //     },
        //     {
        //       run_io_type: "integer",
        //       title: "height",
        //       description: null,
        //       examples: null,
        //       gt: null,
        //       ge: 64,
        //       lt: null,
        //       le: 1024,
        //       multiple_of: null,
        //       allow_inf_nan: null,
        //       max_digits: null,
        //       decimal_places: null,
        //       min_length: null,
        //       max_length: null,
        //       choices: null,
        //       dict_schema: null,
        //       default: 512,
        //     },
        //     {
        //       run_io_type: "integer",
        //       title: "num_images_per_prompt",
        //       description: null,
        //       examples: null,
        //       gt: null,
        //       ge: 1,
        //       lt: null,
        //       le: 4,
        //       multiple_of: null,
        //       allow_inf_nan: null,
        //       max_digits: null,
        //       decimal_places: null,
        //       min_length: null,
        //       max_length: null,
        //       choices: null,
        //       dict_schema: null,
        //       default: 1,
        //     },
        //     {
        //       run_io_type: "integer",
        //       title: "num_inference_steps",
        //       description: null,
        //       examples: null,
        //       gt: null,
        //       ge: null,
        //       lt: null,
        //       le: null,
        //       multiple_of: null,
        //       allow_inf_nan: null,
        //       max_digits: null,
        //       decimal_places: null,
        //       min_length: null,
        //       max_length: null,
        //       choices: null,
        //       dict_schema: null,
        //       default: 50,
        //     },
        //     {
        //       run_io_type: "integer",
        //       title: "width",
        //       description: null,
        //       examples: null,
        //       gt: null,
        //       ge: 64,
        //       lt: null,
        //       le: 1024,
        //       multiple_of: null,
        //       allow_inf_nan: null,
        //       max_digits: null,
        //       decimal_places: null,
        //       min_length: null,
        //       max_length: null,
        //       choices: null,
        //       dict_schema: null,
        //       default: 512,
        //     },
        //   ],
        //   default: null,
        // },

        {
          run_io_type: "dictionary",
          title: "some_object",
          description: null,
          examples: null,
          gt: null,
          ge: null,
          lt: null,
          le: null,
          multiple_of: null,
          allow_inf_nan: null,
          max_digits: null,
          decimal_places: null,
          min_length: null,
          max_length: null,
          choices: null,
          dict_schema: [
            {
              run_io_type: "dictionary",
              title: "nested_arbitrary_dict",
              description: null,
              examples: null,
              gt: null,
              ge: null,
              lt: null,
              le: null,
              multiple_of: null,
              allow_inf_nan: null,
              max_digits: null,
              decimal_places: null,
              min_length: null,
              max_length: null,
              choices: null,
              dict_schema: null,
              default: { in_1: 3 },
            },
            {
              run_io_type: "string",
              title: "choices_1",
              description: null,
              examples: null,
              gt: null,
              ge: null,
              lt: null,
              le: null,
              multiple_of: null,
              allow_inf_nan: null,
              max_digits: null,
              decimal_places: null,
              min_length: null,
              max_length: null,
              choices: ["choice1", "choice2", "choice3"],
              dict_schema: null,
              default: "choice3",
            },
            {
              run_io_type: "array",
              title: "super_array",
              description: null,
              examples: null,
              gt: null,
              ge: null,
              lt: null,
              le: null,
              multiple_of: null,
              allow_inf_nan: null,
              max_digits: null,
              decimal_places: null,
              min_length: null,
              max_length: null,
              choices: null,
              dict_schema: null,
              default: [
                0.011444582603871822, -0.05315866321325302,
                0.021406110376119614, -0.026900190860033035,
                -0.015447557903826237, 0.043529216200113297,
                -0.03459615632891655, 0.00029987774905748665,
                -0.03525491803884506, 0.03108358569443226, 0.01344769261777401,
                -0.0125086959451437, 0.0056375423446297646,
                0.046820446848869324, 0.029219090938568115,
                -0.03583495318889618, 0.043436795473098755,
                0.031827159225940704,
              ],
            },

            // THIS WILL NOT WORK
            // {
            //   run_io_type: "dictionary",
            //   title: "some_nested_dict",
            //   description: null,
            //   examples: null,
            //   gt: null,
            //   ge: null,
            //   lt: null,
            //   le: null,
            //   multiple_of: null,
            //   allow_inf_nan: null,
            //   max_digits: null,
            //   decimal_places: null,
            //   min_length: null,
            //   max_length: 1,
            //   choices: null,
            //   dict_schema: [
            //     {
            //       run_io_type: "dictionary",
            //       title: "nested_arbitrary_dict",
            //       description: null,
            //       examples: null,
            //       gt: null,
            //       ge: null,
            //       lt: null,
            //       le: null,
            //       multiple_of: null,
            //       allow_inf_nan: null,
            //       max_digits: null,
            //       decimal_places: null,
            //       min_length: null,
            //       max_length: null,
            //       choices: null,
            //       dict_schema: null,
            //       default: { in_1: 3 },
            //     },
            //   ],
            //   default: null,
            // },
          ],
          default: null,
        },
      ];

      // Header component
      function Header() {
        return (
          <header class="border-b border-gray-300 p-4">
            <svg
              width="87"
              height="24"
              viewBox="0 0 87 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clip-path="url(#clip0_3607_45180)">
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M0.83701 12.539C0.567095 13.077 0.351708 13.658 0.215387 14.2659C0.0790661 14.8604 0 15.4684 0 16.0897C0 18.2713 0.864275 20.2458 2.27111 21.6822C3.67521 23.1187 5.60824 24.001 7.74303 24.001C9.87781 24.001 11.8108 23.116 13.2149 21.6822C14.6191 20.2458 15.4861 18.2713 15.4861 16.0897C15.4861 15.4684 15.4179 14.8604 15.2843 14.2821C15.148 13.6741 14.8917 13.0259 14.6354 12.5013L8.18743 0.318393C8.06474 0.0843644 7.82209 -0.0393747 7.56581 0.0144249C7.32316 0.0843644 7.18684 0.304943 7.14594 0.565871L6.02538 7.74543C5.99812 7.95256 5.91633 8.14623 5.7282 8.24307C5.54008 8.33991 5.3356 8.32646 5.16111 8.20272L4.06782 7.40111C3.91786 7.30427 3.77064 7.27737 3.60978 7.31772C3.44892 7.35807 3.32623 7.45491 3.24444 7.60824L2.63645 8.85101L0.853369 12.5094L0.839737 12.5363L0.83701 12.539ZM3.55252 15.0649C3.63432 14.7205 3.75428 14.387 3.90423 14.0992L4.51222 12.8564C4.59401 12.7058 4.71398 12.6089 4.87756 12.5659C5.03842 12.5255 5.20201 12.5524 5.3356 12.6493L6.75334 13.6849L8.59094 15.038C8.7518 15.1617 8.96992 15.1752 9.15804 15.0783C9.34616 14.9815 9.45522 14.8012 9.45522 14.5807V12.1355C9.45522 11.8719 9.61608 11.6378 9.87509 11.584C10.1314 11.5275 10.374 11.654 10.4967 11.888L11.59 14.1261C11.74 14.43 11.8463 14.7474 11.9281 15.0783C11.9962 15.3957 12.0371 15.7266 12.0371 16.0871C12.0371 17.3029 11.5655 18.3924 10.7803 19.194C9.99778 19.9821 8.92902 20.4771 7.7403 20.4771C6.55158 20.4771 5.48283 19.9929 4.70034 19.194C3.93149 18.3924 3.44347 17.3029 3.44347 16.0871C3.44347 15.7293 3.47073 15.3823 3.55252 15.0649Z"
                  fill="url(#paint0_linear_3607_45180)"
                />
                <path
                  d="M27.286 19.3514V13.2209C27.286 11.5746 28.2593 10.4798 29.7206 10.4798C31.182 10.4798 32.0599 11.5773 32.0599 13.2209V19.3514H34.2656V13.2209C34.2656 11.6311 35.3071 10.4798 36.7412 10.4798C38.148 10.4933 39.135 11.6311 39.135 13.2209V19.3514H41.327V13.0434C41.327 10.383 39.623 8.51883 37.2019 8.51883C35.7269 8.51883 34.4155 9.27202 33.7121 10.4664C33.1041 9.27471 31.7627 8.49193 30.1541 8.49193C28.9218 8.49193 27.8421 9.09449 27.1905 10.0952V8.9035H25.0667V19.3514H27.286ZM43.4509 23.658C43.9798 23.8921 44.6696 23.9997 45.2503 23.9997C47.4424 23.9997 48.3612 21.9983 49.2554 19.5989L53.2878 8.9035H50.9758L48.1758 16.6103L44.9422 8.9035H42.5348L47.1752 19.3944C46.6462 20.6829 46.2291 22.1221 44.8086 22.1221C44.4024 22.1221 43.8898 21.9983 43.4427 21.8342V23.6446L43.4563 23.658H43.4509ZM62.9311 16.2122C62.9311 13.8531 60.401 13.4146 58.4271 13.0864C56.764 12.7986 55.9924 12.5511 55.9924 11.771C55.9924 10.9344 56.9248 10.3184 58.0345 10.3184C59.5231 10.3184 60.5919 11.0313 60.6191 12.0588H62.6749C62.6749 9.98756 60.7282 8.48117 58.0754 8.48117C55.7361 8.48117 53.9367 9.87996 53.9367 11.8006C53.9367 14.2835 55.7634 14.5982 58.1708 14.9667C59.2123 15.1039 60.81 15.3783 60.81 16.4758C60.8236 17.3393 59.8367 17.9714 58.4571 17.9714C56.9139 17.9714 55.8043 17.0676 55.8043 15.8329H53.7758C53.7758 18.1355 55.7498 19.7952 58.4571 19.7952C61.1644 19.7952 62.9339 18.2996 62.9339 16.2176L62.9311 16.2122ZM65.1232 16.4166C65.1232 18.418 66.3283 19.7629 68.1659 19.7629C68.733 19.7629 69.4636 19.6527 69.9926 19.4751V17.6917C69.6 17.8154 69.1256 17.8692 68.842 17.8692C67.9096 17.8692 67.3398 17.2102 67.3398 16.266V10.6574H69.8562V8.91695H67.3398V6.3803H65.5403L65.2568 8.91695H63.5528V10.6574H65.1368V16.4166H65.1232ZM72.1164 8.91695V19.3648H74.3085V8.91695H72.1164ZM73.2125 7.23033C74.0113 7.23033 74.5784 6.65467 74.5784 5.84499C74.5784 5.03531 74.0086 4.5 73.2125 4.5C72.4164 4.5 71.8329 5.06221 71.8329 5.84499C71.8329 6.62777 72.4 7.23033 73.2125 7.23033ZM81.8579 8.50538C78.7062 8.50538 76.4187 10.8779 76.4187 14.1409C76.4187 17.4038 78.7062 19.7764 81.8716 19.7764C84.4153 19.7764 86.5801 18.1032 87 15.8275L84.8897 15.5531C84.5244 16.8981 83.3329 17.8557 81.8716 17.8557C80.0312 17.8557 78.6244 16.2929 78.6108 14.1274C78.6108 11.9755 80.0449 10.4126 81.8716 10.4126C83.292 10.4126 84.5489 11.3729 84.8734 12.7286L86.9836 12.4543C86.6183 10.1516 84.4671 8.49193 81.8552 8.49193V8.50538H81.8579Z"
                  fill="black"
                />
              </g>
              <defs>
                <linearGradient
                  id="paint0_linear_3607_45180"
                  x1="7.7403"
                  y1="24.001"
                  x2="7.7403"
                  y2="-0.0286145"
                  gradientUnits="userSpaceOnUse"
                >
                  <stop stop-color="#B02EF4" />
                  <stop offset="0.13" stop-color="#A433F4" />
                  <stop offset="0.49" stop-color="#5753EF" />
                  <stop offset="0.78" stop-color="#42CEFD" />
                  <stop offset="1" stop-color="#40D9FF" />
                </linearGradient>
                <clipPath id="clip0_3607_45180">
                  <rect width="87" height="24" fill="white" />
                </clipPath>
              </defs>
            </svg>
          </header>
        );
      }

      function DynamicControlLabel({ id, label, children }) {
        return (
          <label htmlFor={id} className="flex gap-1">
            <span className="text-xs font-medium text-gray-700 whitespace-nowrap">
              {label}
            </span>
            <span className="text-xs font-medium text-gray-500">:</span>
            <span className="text-xs font-medium text-gray-500 whitespace-nowrap">
              {children}
            </span>
          </label>
        );
      }

      function DynamicControl(props) {
        const {
          inputType,
          fieldName,
          label,
          fieldDescription,
          id,
          subType,
          defaultValue,
          options,
          config,
          min,
          max,
          step,
          decimalPlaces,
          optional,
          handleChange,
          parentId,
        } = props;

        if (subType === "string" && options.length === 0) {
          return (
            <div className="flex flex-col gap-1.5">
              <DynamicControlLabel id={id} label={label}>
                {subType}
              </DynamicControlLabel>

              <input
                type="text"
                className="input"
                name={name}
                id={id}
                step={step}
                defaultValue={defaultValue}
                onChange={(e) => handleChange(id, e.target.value, parentId)}
              />
            </div>
          );
        }

        // Dropdown (Strings)
        if (subType === "string" && options.length >= 1) {
          return (
            <div className="flex flex-col gap-1.5">
              <DynamicControlLabel id={id} label={label}>
                {subType}
              </DynamicControlLabel>

              <select
                id={id}
                onChange={(e) => handleChange(id, e.target.value, parentId)}
                defaultValue={defaultValue}
                className="input"
              >
                {options.map((o, index) => (
                  <option value={o.value} key={o.label}>
                    {o.label}
                  </option>
                ))}
              </select>
            </div>
          );
        }

        if (subType === "integer" || subType === "fp") {
          const InputNumberLabel = function () {
            return (
              <DynamicControlLabel id={id} label={label}>
                {subType}{" "}
                {!isNullOrUndefined(min) && isNullOrUndefined(max) ? (
                  <>(minimum {min})</>
                ) : null}
                {isNullOrUndefined(min) && !isNullOrUndefined(max) ? (
                  <>(maximum {max})</>
                ) : null}
                {!isNullOrUndefined(min) && !isNullOrUndefined(max) ? (
                  <>
                    (between {min} and {max})
                  </>
                ) : null}
              </DynamicControlLabel>
            );
          };

          if (!min && !max) {
            return (
              <div className="flex flex-col gap-1.5">
                <InputNumberLabel />
                <input
                  type="number"
                  className="input"
                  name={name}
                  id={id}
                  step={!isNullOrUndefined(step) ? step : undefined}
                  defaultValue={defaultValue}
                  onChange={(e) =>
                    handleChange(id, Number(e.target.value), parentId)
                  }
                />
              </div>
            );
          } else {
            let [value, setValue] = React.useState(defaultValue);

            return (
              <div className="flex flex-col gap-1.5">
                <InputNumberLabel />

                <div class="flex gap-3">
                  <input
                    className="w-10/12"
                    type="range"
                    min={!isNullOrUndefined(min) ? min : undefined}
                    max={!isNullOrUndefined(max) ? max : undefined}
                    step={!isNullOrUndefined(step) ? step : undefined}
                    defaultValue={defaultValue}
                    onChange={(e) => {
                      handleChange(id, Number(e.target.value), parentId);
                      setValue(Number(e.target.value));
                    }}
                  />

                  <p className="w-2/12">{value}</p>
                </div>
              </div>
            );
          }
        }

        // Toggle (Boolean)
        if (subType === "boolean") {
          return (
            <div className="flex flex-col gap-1.5">
              <DynamicControlLabel id={id} label={label}>
                bool
              </DynamicControlLabel>

              <div className="flex">
                <input
                  type="checkbox"
                  id={id}
                  onChange={(e) => handleChange(id, e.target.checked, parentId)}
                  defaultValue={defaultValue}
                />
              </div>
            </div>
          );
        }
        // File upload for file and pkl types
        if (fileRunIOTypes.includes(subType)) {
          // 250 MB limit
          const fileSizeLimit = 250 * 1024 * 1024;

          return (
            <div className="flex flex-col gap-1.5">
              <DynamicControlLabel id={id} label={fieldName}>
                {inputType}
              </DynamicControlLabel>
              <div className="flex">
                <input
                  type="file"
                  id={id}
                  onChange={(e) =>
                    handleChange(id, e.target.files[0], parentId)
                  }
                />
              </div>
            </div>
          );
        }

        function handleTextAreaKeyDown(e) {
          if (event.key === "Tab") {
            event.preventDefault();
            const thisEl = e.currentTarget;

            thisEl.setRangeText(
              "\t",
              thisEl.selectionStart,
              thisEl.selectionStart,
              "end"
            );
          }
        }

        const handleTextAreaChange = (e) => {
          let error = false;
          const thisEl = e.currentTarget;
          const value = e.target.value;

          // Validate that the input valid json
          try {
            const parsed = JSON.parse(value);
            thisEl.classList.remove("error");
            handleChange(id, parsed, parentId);
          } catch (error) {
            thisEl.classList.add("error");
          }
        };

        const handleTextAreaAutoHeight = (e) => {
          const thisEl = e.currentTarget;
          const value = e.target.value;
          thisEl.style.height = "";
          thisEl.style.height = thisEl.scrollHeight + "px";
        };

        if (subType === "array") {
          // Validate that the input valid json
          // we send it along parsed to the backend
          return (
            <div className="flex flex-col gap-1.5">
              <DynamicControlLabel id={id} label={label}>
                array
              </DynamicControlLabel>

              <textarea
                class="textarea whitespace-pre"
                defaultValue={JSON.stringify(defaultValue, null, 4)}
                onChange={(e) => handleTextAreaChange(e)}
                onKeyDown={(e) => handleTextAreaKeyDown(e)}
                onInput={(e) => handleTextAreaAutoHeight(e)}
              />
            </div>
          );
        }

        // If nested arbitrary dictionary
        if (
          subType === "dictionary" &&
          typeof defaultValue === "object" &&
          !Array.isArray(defaultValue) &&
          defaultValue !== null
        ) {
          const ArbitraryInputs = [];
          for (const [key, value] of Object.entries(defaultValue)) {
            ArbitraryInputs.push(
              <div className="flex flex-col gap-1.5" key={key}>
                <DynamicControlLabel id={id} label={label}>
                  Dictionary
                </DynamicControlLabel>
                <textarea
                  class="textarea whitespace-pre"
                  defaultValue={JSON.stringify(defaultValue, null, 4)}
                  onChange={(e) => handleTextAreaChange(e)}
                  onKeyDown={(e) => handleTextAreaKeyDown(e)}
                  onInput={(e) => handleTextAreaAutoHeight(e)}
                />
              </div>
            );
          }

          return ArbitraryInputs;
        }
      }

      // Form component
      function DynamicControls({
        dynamicFields,
        handleInputChange,
        parentId = null,
      }) {
        return dynamicFields.map((dynamicField, index) => {
          return (
            <div key={dynamicField.label} className="flex flex-col gap-2">
              <div className="flex flex-col gap-1">
                <DynamicControl
                  {...dynamicField}
                  id={dynamicField.fieldName}
                  defaultValue={dynamicField.defaultValue}
                  optional={dynamicField.optional}
                  handleChange={handleInputChange}
                  parentId={parentId}
                />
              </div>

              {dynamicField.subType === "dictionary" &&
              dynamicField.dicts &&
              dynamicField.dicts.length ? (
                <div className="flex flex-col gap-1.5">
                  <DynamicControlLabel
                    label={dynamicField.label}
                    id={dynamicField.id}
                  >
                    dictionary
                  </DynamicControlLabel>
                  <div className="flex flex-col gap-5 bg-alternate p-2 md:p-6 rounded-lg">
                    {DynamicControls({
                      dynamicFields: dynamicField.dicts,
                      handleInputChange: handleInputChange,
                      parentId: dynamicField.fieldName,
                    })}
                  </div>
                </div>
              ) : null}
            </div>
          );
        });
      }
      async function handlePostFile(file) {
        const formData = new FormData();
        formData.append("pfile", file);
        const fileData = await fetch(`/v4/files`, {
          method: "POST",
          headers: {
            Accept: "/*",
          },
          body: formData,
        }).then((res) => res.json());
        return fileData;
      }

      async function generateInputDataArrayFromDynamicFields(dynamicFields) {
        const array = [];
        for (const item of dynamicFields) {
          if (item.dicts && item.dicts.length) {
            const newObj = {};
            for (const dict of item.dicts) {
              newObj[dict.label] = dict.defaultValue;
              if (dict.subType === "file") {
                const fileData = await handlePostFile(dict.defaultValue);
                newObj[dict.label] = {
                  type: "file",
                  value: null,
                  file_path: fileData.path,
                };
              }
            }
            array.push({
              type: item.subType,
              value: newObj,
            });
          } else {
            array.push({ type: item.subType, value: item.defaultValue });
            if (item.subType === "file") {
              const fileData = await handlePostFile(item.defaultValue);
              array[array.length - 1].value = null;
              array[array.length - 1].file_path = fileData.path;
            }
          }
        }

        return array;
      }

      function App() {
        const [dynamicFields, setDynamicFields] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(false);
        const [pipeline, setPipeline] = React.useState(null);
        const [outputData, setOutputData] = React.useState(null);
        const [outputErrorData, setErrorOutputData] = React.useState(null);

        // Build child (dict) input data object
        function handleNonParentedField(fieldId, newValue) {
          const field = dynamicFields.find(
            (item) => item.fieldName === fieldId
          );
          const fieldIndex = dynamicFields.findIndex(
            (item) => item.fieldName === fieldId
          );

          const newDynamicFields = [...dynamicFields];
          const newField = {
            ...field,
            defaultValue: newValue,
          };

          newDynamicFields[fieldIndex] = newField;

          setDynamicFields(newDynamicFields);
        }

        // Build root input data object
        function handleParentedField(fieldId, newValue, parentId) {
          {
            const parentFieldIndex = dynamicFields.findIndex(
              (item) => item.fieldName === parentId
            );
            const parentField = dynamicFields.find(
              (item) => item.fieldName === parentId
            );

            const fieldIndex = parentField.dicts.findIndex(
              (item) => item.fieldName === fieldId
            );
            const field = parentField.dicts.find(
              (item) => item.fieldName === fieldId
            );
            if (!field) return;

            // update the child field
            const newChildField = { ...field, defaultValue: newValue };
            const newDicts = [...parentField.dicts];
            newDicts[fieldIndex] = newChildField;

            // The field is a dictionary, we need to update the state of the parent
            const newParentField = {
              ...parentField,
              dicts: newDicts,
            };

            const newDynamicFields = [...dynamicFields];
            newDynamicFields[parentFieldIndex] = newParentField;

            setDynamicFields(newDynamicFields);
          }
        }

        // Handle input change from form
        function handleSetDynamicState(fieldId, newValue, parentId) {
          if (!parentId) handleNonParentedField(fieldId, newValue);
          else handleParentedField(fieldId, newValue, parentId);
        }

        // => { file: RunOutputFile }
        function PipelineFileResponse({ file }) {
          const [blobUrl, setBlobUrl] = React.useState(null);
          React.useEffect(() => {
            fetch(`/v4/files/download/${file.path}`).then(async (res) => {
              const blob = await res.blob();
              setBlobUrl(URL.createObjectURL(blob));
            });
          }, []);
          if (!blobUrl) return <></>;
          if (
            file.path.includes("png") ||
            file.path.includes("jpg") ||
            file.path.includes("jpeg")
          ) {
            return (
              <img src={blobUrl} alt={file.name} className="w-full max-w-lg" />
            );
          } else if (
            file.path.includes("wav") ||
            file.path.includes("mp3") ||
            file.path.includes("ogg") ||
            file.path.includes("flac") ||
            file.path.includes("m4a") ||
            file.path.includes("aac") ||
            file.path.includes("opus") ||
            file.path.includes("wma")
          ) {
            return (
              <audio controls src={blobUrl} className="w-full">
                <a href={blobUrl}> Download audio </a>
                Your browser does not support the audio element.
              </audio>
            );
          } else if (
            file.path.includes("ogg") ||
            file.path.includes("mp4") ||
            file.path.includes("mov") ||
            file.path.includes("wmv") ||
            file.path.includes("flv") ||
            file.path.includes("avi") ||
            file.path.includes("avchd") ||
            file.path.includes("webm") ||
            file.path.includes("mkv")
          ) {
            return (
              <div className="aspect-video">
                <video controls>
                  {/* Provide a fallback for browsers that don't support this format */}
                  <source src={blobUrl} type="video/ogg" />
                  <source src={blobUrl} type="video/mp4" />
                  <source src={blobUrl} type="video/mov" />
                  <source src={blobUrl} type="video/wmv" />
                  <source src={blobUrl} type="video/flv" />
                  <source src={blobUrl} type="video/avi" />
                  <source src={blobUrl} type="video/avchd" />
                  <source src={blobUrl} type="video/webm" />
                  <source src={blobUrl} type="video/mkv" />
                </video>
              </div>
            );
          } else {
            return <></>;
          }
        }

        function RenderOutput({ output }) {
          // => RunOutput[]
          const renderFiles = (value) => {
            // => RunOutput
            const renderedFiles = value.map((file, idx) => {
              return <li key={idx}>{renderFile(file.file)}</li>;
            });
            return <ul className="flex flex-col gap-6">{renderedFiles}</ul>;
          };

          // => RunOutputFile
          const renderFile = (file) => {
            return (
              // TODO: Add a tab for the file contents, and it's raw response
              <PipelineFileResponse file={file} />
            );
          };

          // => string
          const renderString = (value) => {
            return (
              <pre class="bg-gray-700 text-white rounded p-2 overflow-auto">
                {value}
              </pre>
            );
          };

          // => any[]
          const renderArray = (value) => {
            // If array of files
            let isArrayOfFiles = value.find((x) => x.type == "file");
            if (isArrayOfFiles) {
              return renderFiles(value);
            }

            // If array of other types, print full array
            return (
              <ul className="flex flex-col gap-6">
                <pre class="bg-gray-700 text-white rounded p-2 overflow-auto">
                  {JSON.stringify(value, null, 2)}
                </pre>
              </ul>
            );
          };

          // Render Object function
          const renderObject = (value) => (
            <ul className="flex flex-col gap-4">
              <pre class="bg-gray-700 text-white rounded p-2 overflow-auto">
                {JSON.stringify(value, null, 2)}
              </pre>
            </ul>
          );

          switch (output.type) {
            case "file":
              return renderFile(output.file);

            case "dictionary":
              return renderObject(output.value);

            case "string":
              return renderString(output.value);

            case "array":
              return renderArray(output.value);
          }

          // Edge cases: If not known type, continue to render special cases
          if (isObject(output)) {
            return renderObject(output);
          }
          if (isArray(output)) {
            return renderArray(output);
          }

          return null;
        }

        // POST data
        function handleSubmit(e) {
          e.preventDefault();

          // Set loading
          setIsLoading(true);
          generateInputDataArrayFromDynamicFields(dynamicFields).then(
            (inputData) => {
              // Reset outputs
              setOutputData(null);
              setErrorOutputData(null);

              fetch(`/v4/runs`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },

                body: JSON.stringify({ inputs: inputData }),
              })
                .then((res) => res.json())
                .then((data) => {
                  if (data.error !== null) {
                    setErrorOutputData(data);
                  } else {
                    setOutputData(data.outputs);
                    // setOutputData(mockOutputIOVariables);
                  }
                  setIsLoading(false);
                })
                .catch((err) => console.log(err));
            }
          );
        }

        // GET pipeline
        React.useEffect(() => {
          fetch(`/v4/container/pipeline`)
            .then((res) => res.json())
            .then((data) => {
              setPipeline(data);

              const dynamicFields = generateDynamicFieldsFromIOVariables(
                data.input_variables
              );
              // const dynamicFields =
              //   generateDynamicFieldsFromIOVariables(mockInputIOVariables);

              setDynamicFields(dynamicFields);
            })
            .catch((err) => console.log(err));
        }, []);

        return (
          <div className="flex flex-col pb-12">
            <Header />

            <div class="flex justify-center">
              {/* input */}
              <form
                onSubmit={(e) => handleSubmit(e)}
                class="flex flex-col gap-5 md:w-96 p-6 border-r border-gray-300"
              >
                <h2 className="text-2xl font-bold">Input</h2>
                <DynamicControls
                  dynamicFields={dynamicFields}
                  handleInputChange={(fieldId, text, parentId) =>
                    handleSetDynamicState(fieldId, text, parentId)
                  }
                />
                <div class="sticky bottom-8">
                  <button className="button w-full" type="submit">
                    {isLoading ? "Loading..." : "Run"}
                  </button>
                </div>
              </form>

              {/* output */}
              <div class="md:w-96 p-6 h-screen">
                <div className="flex flex-col gap-5">
                  <h2 className="text-2xl font-bold">Output</h2>
                  {outputErrorData ? (
                    <pre class="bg-red-50 rounded p-2 overflow-auto">
                      {JSON.stringify(outputErrorData, null, 2)}
                    </pre>
                  ) : null}

                  {/* Raw output */}
                  {outputData ? (
                    <pre class="bg-gray-100 rounded p-2 overflow-auto">
                      {JSON.stringify(outputData, null, 2)}
                    </pre>
                  ) : null}

                  {isLoading ? (
                    <pre class="bg-gray-100 rounded p-2 overflow-auto h-36 w-full animate-pulse ">
                      loading...
                    </pre>
                  ) : (
                    <>
                      {/* Rendered output */}
                      {outputData
                        ? outputData.map((output, idx) => (
                            <div key={idx}>
                              <RenderOutput output={output} />
                            </div>
                          ))
                        : null}
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Render the router
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>

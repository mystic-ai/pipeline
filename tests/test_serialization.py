from pipeline.objects.graph import Graph

from pipeline.schemas.pipeline import PipelineGet

test_pipeline_dict = {
    "id": "pipeline_72c96d162d3347c38f83e56ce982455b",
    "type": "pipeline",
    "name": "HF pipeline",
    "project": {
        "avatar_colour": "#AA2216",
        "avatar_image_url": None,
        "name": "Default",
        "id": "project_3b0253647cc844619ad5b5288af40e7d",
    },
    "variables": [
        {
            "local_id": "lpacWxZNeq",
            "name": None,
            "type_file": {
                "name": "jaahNwIiBykPFqgeXQJG",
                "id": "file_ec28640d32b947308b34248c4bb87aeb",
                "path": "object_dy8tcccflt315cmzgu3pivyw4w7h5l4im4wxefbexz4jxsdg5fdkqc80qpw2sxyx",
                "data": "80049527000000000000008c0a64696c6c2e5f64696c6c948c0a5f6c6f61645f747970659493948c0373747294859452942e",
                "file_size": 100,
            },
            "type_file_id": None,
            "is_input": True,
            "is_output": False,
        },
        {
            "local_id": "aDhXvxVeKl",
            "name": None,
            "type_file": {
                "name": "nAJGkyZMSlvIJmGTlkMp",
                "id": "file_79b7384d35e54692939561a4e7e28a2e",
                "path": "object_yrk5vc6tuowny9ysglpzdhuqm73j2wb50xjgmv9nio4n6jvh0vjrzpnipcqzncdu",
                "data": "80049527000000000000008c0a64696c6c2e5f64696c6c948c0a5f6c6f61645f747970659493948c0373747294859452942e",
                "file_size": 100,
            },
            "type_file_id": None,
            "is_input": False,
            "is_output": True,
        },
    ],
    "functions": [
        {
            "id": "function_a66fae56c86e40769b4b01481b83c9b0",
            "type": "function",
            "name": "predict",
            "project": {
                "avatar_colour": "#AA2216",
                "avatar_image_url": None,
                "name": "Default",
                "id": "project_3b0253647cc844619ad5b5288af40e7d",
            },
            "hex_file": {
                "name": "LZpywTMKOoFwqOKNMEqB",
                "id": "file_9ec0d8d609f54e8daaa9fb4d1f2291f5",
                "path": "object_y1u1tgfvxb2t8jojo4owted8i09nijaae9ndnsmtn0ci4pjnnc3s3c61lxo7ld3v",
                "data": "800495e20c0000000000008c19706970656c696e652e6f626a656374732e66756e6374696f6e948c0846756e6374696f6e9493942981947d94288c046e616d65948c0770726564696374948c0972656d6f74655f6964944e8c0e636c6173735f696e7374616e6365948c0a64696c6c2e5f64696c6c948c0c5f6372656174655f747970659493942868098c0a5f6c6f61645f747970659493948c047479706594859452948c1c5472616e73666f726d6572734d6f64656c466f7243617573616c4c4d94680d8c066f626a656374948594529485947d94288c0a5f5f6d6f64756c655f5f948c085f5f6d61696e5f5f948c085f5f696e69745f5f9468098c105f6372656174655f66756e6374696f6e9493942868098c0c5f6372656174655f636f6465949394284b034b004b004b034b024b43431c7c017c005f007c027c005f0164007c005f0264007c005f0364005300944e8594288c0a6d6f64656c5f70617468948c0e746f6b656e697a65725f70617468948c056d6f64656c948c09746f6b656e697a65729474948c0473656c66946820682187948c512f55736572732f7061756c2f6d79737469632f706970656c696e652d737461636b2f706970656c696e652f6578616d706c65732f68756767696e67666163652f6770742d6e656f2d75706c6f61642e70799468194b104308000506010601060194292974945294635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a68198c17456c65757468657241492f6770742d6e656f2d3132354d94682b86944e7d944e749452946806681b28681d284b004b004b004b074b054b1f43c874006a01731488007c0069007c01a4018e01530088006a027d0264017c027601722a740364028301820167007d037c0044005d4a7d0474047c0474058302724c7c03a0067c04a1010100713274077c0464038302726c88006a086a0964007500727c7c0488006a085f09713274036404740a7c0483011600830182017132740588006a026401190064058d017d057400a00b7c05a10101007400a00c88006a08a1010100740d88006a087c037c05670164068d037d067400a00e7c06a10101007c0553006400530094284e8c0672657475726e948c3b4d75737420696e636c75646520616e206f7574707574207479706520652e672e2027646566206d795f66756e63282e2e2e29202d3e20696e743a27948c125f5f706970656c696e655f6d6f64656c5f5f948c4d596f752063616e277420696e7075742072616e646f6d207661726961626c65732c20666f6c6c6f772074686520776179206f662074686520506970656c696e652e20476f742074797065202573948c0a747970655f636c6173739485948c0866756e6374696f6e948c06696e70757473948c076f7574707574739487947494288c08506970656c696e65948c185f706970656c696e655f636f6e746578745f616374697665948c0f5f5f616e6e6f746174696f6e735f5f948c09457863657074696f6e948c0a6973696e7374616e6365948c085661726961626c65948c06617070656e64948c0768617361747472948c155f5f706970656c696e655f66756e6374696f6e5f5f946808680e8c0c6164645f7661726961626c65948c0c6164645f66756e6374696f6e948c0947726170684e6f6465948c0e6164645f67726170685f6e6f6465947494288c0461726773948c066b7761726773948c0c66756e6374696f6e5f696f73948c0e70726f6365737365645f61726773948c09696e7075745f617267948c0b6e6f64655f6f7574707574948c086e65775f6e6f64659474948c492f55736572732f7061756c2f6d79737469632f706970656c696e652d737461636b2f706970656c696e652f706970656c696e652f6f626a656374732f6465636f7261746f72732e7079948c0c657865637574655f66756e63944b09433a000106010e0206010801020102ff0404040108010a010c010a010c010a020202020206fe02fe060810010a010c0102010401020104fd06050a029468378594297494529463706970656c696e652e6f626a656374732e6465636f7261746f72730a5f5f646963745f5f0a68534e68098c0c5f6372656174655f63656c6c949394681b28681d284b034b004b004b064b044b4343387c006a007c01640164028d026a017d037c006a026a037c03660169007c02a4018e017d047c006a00a0047c04a101640319007d057c05530094284e8c027074948c0e72657475726e5f74656e736f72739485944b0074942868238c09696e7075745f6964739468228c0867656e6572617465948c0c62617463685f6465636f64659474942868258c0a696e7075745f64617461948c0c6d6f64656c5f6b776172677394685f8c0a67656e5f746f6b656e73948c0867656e5f74657874947494682768064b1a4308000210011401100194292974945294635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a68067d9485944e7d9468446803734e749452948594529485947d948c0c5f5f66756e6374696f6e5f5f94686f734e749452948c046c6f616494681b28685763706970656c696e652e6f626a656374732e6465636f7261746f72730a5f5f646963745f5f0a68534e6859681b28681d284b014b004b004b044b034b43434c640164026c006d017d016d027d020100640164006c007d037c006a036400750072307c01a0047c006a05a1017c005f037c006a066400750072487c02a0047c006a07a1017c005f0664005300944e4b008c144175746f4d6f64656c466f7243617573616c4c4d948c0d4175746f546f6b656e697a65729486948794288c0c7472616e73666f726d657273946879687a68228c0f66726f6d5f707265747261696e65649468206823682174942868256879687a687d7494682768774b21430c0002100108020a010e010a0194292974945294635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a68774e4e7d94684468022981947d94286805687768074e68084e6837681b286883635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a68774e4e68844e749452948c06736f757263659458760100002020202040706970656c696e655f66756e6374696f6e0a20202020646566206c6f61642873656c6629202d3e204e6f6e653a0a202020202020202066726f6d207472616e73666f726d65727320696d706f7274204175746f4d6f64656c466f7243617573616c4c4d2c204175746f546f6b656e697a65720a2020202020202020696d706f7274207472616e73666f726d6572730a0a202020202020202069662073656c662e6d6f64656c206973204e6f6e653a0a20202020202020202020202073656c662e6d6f64656c203d204175746f4d6f64656c466f7243617573616c4c4d2e66726f6d5f707265747261696e65642873656c662e6d6f64656c5f70617468290a202020202020202069662073656c662e746f6b656e697a6572206973204e6f6e653a0a20202020202020202020202073656c662e746f6b656e697a6572203d204175746f546f6b656e697a65722e66726f6d5f707265747261696e65642873656c662e746f6b656e697a65725f70617468290a948c0468617368948c4033376435303239333733366665336664613031343130313937363734303637616361323736376134333731306461626235386438373432333736396332623563948c0e747970696e675f6f757470757473947d9468314e738c0d747970696e675f696e70757473947d948c086c6f63616c5f6964948c0a786d634f4951796d7345947562734e7494523068888594529485947d9468746888734e749452948c075f5f646f635f5f944e6833888c0d5f5f736c6f746e616d65735f5f945d9475749452942981947d94286820682b6821682b68224e68234e68918c0a4a75696a58744f706f439475626837686f688958470100002020202040706970656c696e655f66756e6374696f6e0a2020202064656620707265646963742873656c662c20696e7075745f646174613a207374722c206d6f64656c5f6b77617267733a2064696374203d207b7d29202d3e207374723a0a2020202020202020696e7075745f696473203d2073656c662e746f6b656e697a657228696e7075745f646174612c2072657475726e5f74656e736f72733d22707422292e696e7075745f6964730a202020202020202067656e5f746f6b656e73203d2073656c662e6d6f64656c2e67656e657261746528696e7075745f6964732c202a2a6d6f64656c5f6b7761726773290a202020202020202067656e5f74657874203d2073656c662e746f6b656e697a65722e62617463685f6465636f64652867656e5f746f6b656e73295b305d0a202020202020202072657475726e2067656e5f746578740a94688b8c403736383839633931643837326463656435646330343966363663633837353638666637393930633961373565373561393836646630333965663765326666306694688d7d946831680d8c03737472948594529473688f7d9428686368a76864680d8c046469637494859452947568918c0a6f4b6d55684e455668639475622e",
                "file_size": 6618,
            },
            "source_sample": '    @pipeline_function\n    def predict(self, input_data: str, model_kwargs: dict = {}) -> str:\n        input_ids = self.tokenizer(input_data, return_tensors="pt").input_ids\n        gen_tokens = self.m',
        }
    ],
    "models": [
        {
            "id": "model_10d70951463e474a9126ec6e857249cb",
            "name": "",
            "hex_file": {
                "name": "bfdVXaRkimcSfnDQpQGR",
                "id": "file_6c42a41051fb42f68a3d43440cd0c2a4",
                "path": "object_9h5z82oyjrjgx9f89q5yuenipjrypg14yrj3kx0bitviu7nqpmgx66tyqbxn0qsd",
                "data": "80049532120000000000008c16706970656c696e652e6f626a656374732e6d6f64656c948c054d6f64656c9493942981947d94288c046e616d65948c00948c056d6f64656c948c0a64696c6c2e5f64696c6c948c0c5f6372656174655f747970659493942868088c0a5f6c6f61645f747970659493948c047479706594859452948c1c5472616e73666f726d6572734d6f64656c466f7243617573616c4c4d94680c8c066f626a656374948594529485947d94288c0a5f5f6d6f64756c655f5f948c085f5f6d61696e5f5f948c085f5f696e69745f5f9468088c105f6372656174655f66756e6374696f6e9493942868088c0c5f6372656174655f636f6465949394284b034b004b004b034b024b43431c7c017c005f007c027c005f0164007c005f0264007c005f0364005300944e8594288c0a6d6f64656c5f70617468948c0e746f6b656e697a65725f706174689468078c09746f6b656e697a65729474948c0473656c6694681f682087948c512f55736572732f7061756c2f6d79737469632f706970656c696e652d737461636b2f706970656c696e652f6578616d706c65732f68756767696e67666163652f6770742d6e656f2d75706c6f61642e70799468184b104308000506010601060194292974945294635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a68188c17456c65757468657241492f6770742d6e656f2d3132354d94682986944e7d944e749452948c077072656469637494681a28681c284b004b004b004b074b054b1f43c874006a01731488007c0069007c01a4018e01530088006a027d0264017c027601722a740364028301820167007d037c0044005d4a7d0474047c0474058302724c7c03a0067c04a1010100713274077c0464038302726c88006a086a0964007500727c7c0488006a085f09713274036404740a7c0483011600830182017132740588006a026401190064058d017d057400a00b7c05a10101007400a00c88006a08a1010100740d88006a087c037c05670164068d037d067400a00e7c06a10101007c0553006400530094284e8c0672657475726e948c3b4d75737420696e636c75646520616e206f7574707574207479706520652e672e2027646566206d795f66756e63282e2e2e29202d3e20696e743a27948c125f5f706970656c696e655f6d6f64656c5f5f948c4d596f752063616e277420696e7075742072616e646f6d207661726961626c65732c20666f6c6c6f772074686520776179206f662074686520506970656c696e652e20476f742074797065202573948c0a747970655f636c6173739485948c0866756e6374696f6e948c06696e70757473948c076f7574707574739487947494288c08506970656c696e65948c185f706970656c696e655f636f6e746578745f616374697665948c0f5f5f616e6e6f746174696f6e735f5f948c09457863657074696f6e948c0a6973696e7374616e6365948c085661726961626c65948c06617070656e64948c0768617361747472948c155f5f706970656c696e655f66756e6374696f6e5f5f948c0e636c6173735f696e7374616e636594680d8c0c6164645f7661726961626c65948c0c6164645f66756e6374696f6e948c0947726170684e6f6465948c0e6164645f67726170685f6e6f6465947494288c0461726773948c066b7761726773948c0c66756e6374696f6e5f696f73948c0e70726f6365737365645f61726773948c09696e7075745f617267948c0b6e6f64655f6f7574707574948c086e65775f6e6f64659474948c492f55736572732f7061756c2f6d79737469632f706970656c696e652d737461636b2f706970656c696e652f706970656c696e652f6f626a656374732f6465636f7261746f72732e7079948c0c657865637574655f66756e63944b09433a000106010e0206010801020102ff0404040108010a010c010a010c010a020202020206fe02fe060810010a010c0102010401020104fd06050a029468368594297494529463706970656c696e652e6f626a656374732e6465636f7261746f72730a5f5f646963745f5f0a68534e68088c0c5f6372656174655f63656c6c949394681a28681c284b034b004b004b064b044b4343387c006a007c01640164028d026a017d037c006a026a037c03660169007c02a4018e017d047c006a00a0047c04a101640319007d057c05530094284e8c027074948c0e72657475726e5f74656e736f72739485944b0074942868218c09696e7075745f6964739468078c0867656e6572617465948c0c62617463685f6465636f64659474942868238c0a696e7075745f64617461948c0c6d6f64656c5f6b776172677394685f8c0a67656e5f746f6b656e73948c0867656e5f746578749474946825682e4b1a4308000210011401100194292974945294635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a682e7d9485944e7d9468438c19706970656c696e652e6f626a656374732e66756e6374696f6e948c0846756e6374696f6e9493942981947d94286805682e8c0972656d6f74655f6964944e6844680a28680f681068147d9428681668176818682d682e681a28685763706970656c696e652e6f626a656374732e6465636f7261746f72730a5f5f646963745f5f0a68534e6859681a28686a635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a682e686c4e686d4e749452948594529485947d948c0c5f5f66756e6374696f6e5f5f946876734e749452948c046c6f616494681a28685763706970656c696e652e6f626a656374732e6465636f7261746f72730a5f5f646963745f5f0a68534e6859681a28681c284b014b004b004b044b034b43434c640164026c006d017d016d027d020100640164006c007d037c006a036400750072307c01a0047c006a05a1017c005f037c006a066400750072487c02a0047c006a07a1017c005f0664005300944e4b008c144175746f4d6f64656c466f7243617573616c4c4d948c0d4175746f546f6b656e697a65729486948794288c0c7472616e73666f726d657273946880688168078c0f66726f6d5f707265747261696e656494681f68216820749428682368806881688474946825687e4b21430c0002100108020a010e010a0194292974945294635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a687e4e4e7d94684368702981947d94286805687e68734e68444e6836681a28688a635f5f6275696c74696e5f5f0a5f5f6d61696e5f5f0a687e4e4e688b4e749452948c06736f757263659458760100002020202040706970656c696e655f66756e6374696f6e0a20202020646566206c6f61642873656c6629202d3e204e6f6e653a0a202020202020202066726f6d207472616e73666f726d65727320696d706f7274204175746f4d6f64656c466f7243617573616c4c4d2c204175746f546f6b656e697a65720a2020202020202020696d706f7274207472616e73666f726d6572730a0a202020202020202069662073656c662e6d6f64656c206973204e6f6e653a0a20202020202020202020202073656c662e6d6f64656c203d204175746f4d6f64656c466f7243617573616c4c4d2e66726f6d5f707265747261696e65642873656c662e6d6f64656c5f70617468290a202020202020202069662073656c662e746f6b656e697a6572206973204e6f6e653a0a20202020202020202020202073656c662e746f6b656e697a6572203d204175746f546f6b656e697a65722e66726f6d5f707265747261696e65642873656c662e746f6b656e697a65725f70617468290a948c0468617368948c4033376435303239333733366665336664613031343130313937363734303637616361323736376134333731306461626235386438373432333736396332623563948c0e747970696e675f6f757470757473947d9468304e738c0d747970696e675f696e70757473947d948c086c6f63616c5f6964948c0a786d634f4951796d7345947562734e74945230688f8594529485947d94687b688f734e749452948c075f5f646f635f5f944e6832888c0d5f5f736c6f746e616d65735f5f945d9475749452942981947d9428681f68296820682968074e68214e68988c0a4a75696a58744f706f4394756268366876689058470100002020202040706970656c696e655f66756e6374696f6e0a2020202064656620707265646963742873656c662c20696e7075745f646174613a207374722c206d6f64656c5f6b77617267733a2064696374203d207b7d29202d3e207374723a0a2020202020202020696e7075745f696473203d2073656c662e746f6b656e697a657228696e7075745f646174612c2072657475726e5f74656e736f72733d22707422292e696e7075745f6964730a202020202020202067656e5f746f6b656e73203d2073656c662e6d6f64656c2e67656e657261746528696e7075745f6964732c202a2a6d6f64656c5f6b7761726773290a202020202020202067656e5f74657874203d2073656c662e746f6b656e697a65722e62617463685f6465636f64652867656e5f746f6b656e73295b305d0a202020202020202072657475726e2067656e5f746578740a9468928c40373638383963393164383732646365643564633034396636366363383735363866663739393063396137356537356139383664663033396566376532666630669468947d946830680c8c0373747294859452947368967d9428686368ae6864680c8c046469637494859452947568988c2966756e6374696f6e5f6136366661653536633836653430373639623462303134383162383363396230947562734e749452306876859452306878306879687a4e74945230687d687e68a068a14e68328868a268a3757494523068a529813068a668a7626890581204000040706970656c696e655f6d6f64656c0a636c617373205472616e73666f726d6572734d6f64656c466f7243617573616c4c4d3a0a20202020646566205f5f696e69745f5f280a202020202020202073656c662c0a20202020202020206d6f64656c5f706174683a20737472203d2022456c65757468657241492f6770742d6e656f2d3132354d222c0a2020202020202020746f6b656e697a65725f706174683a20737472203d2022456c65757468657241492f6770742d6e656f2d3132354d222c0a20202020293a0a202020202020202073656c662e6d6f64656c5f70617468203d206d6f64656c5f706174680a202020202020202073656c662e746f6b656e697a65725f70617468203d20746f6b656e697a65725f706174680a202020202020202073656c662e6d6f64656c203d204e6f6e650a202020202020202073656c662e746f6b656e697a6572203d204e6f6e650a0a2020202040706970656c696e655f66756e6374696f6e0a2020202064656620707265646963742873656c662c20696e7075745f646174613a207374722c206d6f64656c5f6b77617267733a2064696374203d207b7d29202d3e207374723a0a2020202020202020696e7075745f696473203d2073656c662e746f6b656e697a657228696e7075745f646174612c2072657475726e5f74656e736f72733d22707422292e696e7075745f6964730a202020202020202067656e5f746f6b656e73203d2073656c662e6d6f64656c2e67656e657261746528696e7075745f6964732c202a2a6d6f64656c5f6b7761726773290a202020202020202067656e5f74657874203d2073656c662e746f6b656e697a65722e62617463685f6465636f64652867656e5f746f6b656e73295b305d0a202020202020202072657475726e2067656e5f746578740a0a2020202040706970656c696e655f66756e6374696f6e0a20202020646566206c6f61642873656c6629202d3e204e6f6e653a0a202020202020202066726f6d207472616e73666f726d65727320696d706f7274204175746f4d6f64656c466f7243617573616c4c4d2c204175746f546f6b656e697a65720a2020202020202020696d706f7274207472616e73666f726d6572730a0a202020202020202069662073656c662e6d6f64656c206973204e6f6e653a0a20202020202020202020202073656c662e6d6f64656c203d204175746f4d6f64656c466f7243617573616c4c4d2e66726f6d5f707265747261696e65642873656c662e6d6f64656c5f70617468290a202020202020202069662073656c662e746f6b656e697a6572206973204e6f6e653a0a20202020202020202020202073656c662e746f6b656e697a6572203d204175746f546f6b656e697a65722e66726f6d5f707265747261696e65642873656c662e746f6b656e697a65725f70617468290a9468928c403130623164393538666534353266656533616336326331346436396538333234313532626338326137643665373237323030396639393837366664393365643494689868a875622e",
                "file_size": 9338,
            },
            "source_sample": '@pipeline_model\nclass TransformersModelForCausalLM:\n    def __init__(\n        self,\n        model_path: str = "EleutherAI/gpt-neo-125M",\n        tokenizer_path: str = "EleutherAI/gpt-neo-125M",\n    ):',
        }
    ],
    "graph_nodes": [
        {
            "local_id": "SbSVsUkIkc",
            "function": "function_a66fae56c86e40769b4b01481b83c9b0",
            "inputs": ["lpacWxZNeq"],
            "outputs": ["aDhXvxVeKl"],
        }
    ],
    "outputs": ["aDhXvxVeKl"],
}

test_pipeline_schema = PipelineGet.parse_obj(test_pipeline_dict)


def test_model_serialization():
    reformed_graph = Graph.from_schema(test_pipeline_schema)

    # Check basic graph is in correct format
    assert len(reformed_graph.models) == 1
    assert len(reformed_graph.functions) == 1
    assert len(reformed_graph.variables) == 2

    # Check that the only node function has been correctly binded to the model
    assert (
        reformed_graph.nodes[0].function.class_instance
        == reformed_graph.models[0].model
    )

    # TODO Add actual run check
